---
title: "Transfer analyses"
output: html_document
---

```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
```

# load data
```{r}
num_runs = 67
num_layerss = 2:4
```

```{r}
d = data.frame()
for (run_i in 0:(num_runs-1)) {
  for (num_layers in num_layerss) {
    for (analogous in 0:1) {
      for (nonlinear in 0:1) {
        filename = sprintf("results_swapped_structures/nlayer_%i_nonlinear_%i_analogous_%i_rseed_%i_loss_track.csv",
                           num_layers, nonlinear, analogous, run_i)
        this_d = read_csv(filename) %>%
          mutate(run=run_i, nonlinear=nonlinear==1, analogous=factor(analogous, levels=0:1, labels=c("non-analogous", "analogous")), num_layers=num_layers)
        d = bind_rows(d, this_d)
      }
    }
  }
}
```

```{r}
d = d %>%
  filter((num_layers==5 & epoch %% 500 == 0) | (num_layers==4 & epoch %% 200 == 0) | (num_layers == 3 & epoch %% 50 == 0) | num_layers == 2) %>%
  complete(run, analogous, nesting(nonlinear, num_layers, epoch), fill=list(MSE=0, d1_MSE=0)) 
```


# basic analysis
```{r}
theme_set(theme_bw() +
          theme(panel.grid=element_blank()))
```

```{r}
ggplot(data=d, aes(x=epoch, y=d1_MSE, color=analogous)) +
  geom_line(stat="summary", fun.y=median, size=1) +
  geom_line(aes(group=interaction(run, analogous)), alpha=0.1) +
  facet_wrap(.~nonlinear + num_layers, scales="free_x") +
  labs(y="Loss (L2)") +
  scale_color_brewer(palette="Set1")
```

```{r}
ggsave("plots/basic_transfer_comparison.png", width=8, height=4)
```

```{r}
learned_d = d %>%
  filter(d1_MSE < 0.05) %>%
  group_by(nonlinear, analogous, num_layers, run) %>%
  summarize(learned_epoch = min(epoch)) %>%
  ungroup()
```


```{r}
model = lmer(learned_epoch ~ analogous  * nonlinear + (1 | run), learned_d %>% filter(num_layers==3))

summary(model)
```

```{r}
learned_diff_d = learned_d %>%
  spread(analogous, learned_epoch) %>%
  mutate(learn_diff = `non-analogous` - `analogous`)
```

```{r}
ggplot(learned_d %>% filter(nonlinear, num_layers==3), aes(x=learned_epoch, color=analogous)) +
  geom_line(stat="density") +
  facet_grid(. ~ num_layers, scales="free")
```
```{r}
ggsave("plots/basic_transfer_stopping_times.png", width=8, height=4)
```


```{r}
ggplot(learned_diff_d %>% filter(nonlinear, num_layers==3), aes(x=learn_diff)) +
  geom_line(stat="density") +
  facet_grid(. ~ num_layers, scales="free") +
  labs(x="Amount longer it took to learn non-analogous")
```

```{r}
ggsave("plots/basic_transfer_stopping_time_differences.png", width=8, height=4)
```


```{r}
sorted_diff_d = arrange(learned_diff_d %>% filter(num_layers==3, nonlinear), desc(learn_diff))
head(sorted_diff_d)

tail(sorted_diff_d)

```

```{r}
ggplot(data=d %>% filter(run %in% c(80, 104, 107), num_layers==3, nonlinear), aes(x=epoch, y=d1_MSE, color=analogous)) +
  geom_line(aes(group=interaction(run, analogous))) +
  labs(y="Loss (L2)") +
  scale_color_brewer(palette="Set1")
```

Since we know in the 3 layer case that the transfer effect **must** be happening at the middle layer, since these are the only shared weights. This provides a nice target for analysis.

## why are some 4-layer linear runs showing effects in the other direction?


```{r}
ggplot(data=d %>% filter(run %in% c(98), num_layers==4, !nonlinear), aes(x=epoch, y=d1_MSE, color=analogous)) +
  geom_line(aes(group=interaction(run, analogous))) +
  labs(y="Loss (L2)") +
  scale_color_brewer(palette="Set1")
```

```{r}
ggplot(data=d %>% filter(run %in% c(98), num_layers==4, !nonlinear), aes(x=epoch, y=MSE, color=analogous)) +
  geom_line(aes(group=interaction(run, analogous))) +
  labs(y="Loss (L2)") +
  scale_color_brewer(palette="Set1")
```

Might just be single-domain weirdness and the exaggeration that happens with depth... Should investigate further.


# Investigating how the penultimate layer weights change

```{r}
detailed_runs = c(66, 80, 104, 107)
num_layers = 3
```

```{r}
weight_d = data.frame()
for (run_i in detailed_runs) {
  for (analogous in 0:1) {
    for (nonlinear in 0:1) {
      for (epoch in seq(0, 200000, 100)) {
        filename = sprintf("results/nlayer_%i_nonlinear_%i_analogous_%i_rseed_%i_penultimate_S_epoch_%i.csv",
                           num_layers, nonlinear, analogous, run_i, epoch)
        if (!file.exists(filename)) {
          next
        }
        this_d = read_csv(filename, col_names=c("S")) %>%
          mutate(run=run_i, epoch=epoch, nonlinear=nonlinear==1, analogous=factor(analogous, levels=0:1, labels=c("non-analogous", "analogous")), num_layers=num_layers, S_rank=1:6)
        weight_d = bind_rows(weight_d, this_d)
      }
    }
  }
}
```


```{r}

```

